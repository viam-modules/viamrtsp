name: Integration test using mediamtx

on:
  push:
    paths-ignore:
      - 'README.md'
  pull_request:
    paths-ignore:
      - 'README.md'

jobs:
  build:
    name: Build (${{ matrix.os }}/${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            os: linux
            arch: amd64
            docker_image: ghcr.io/viamrobotics/antique2:amd64-cache
          - runner: buildjet-8vcpu-ubuntu-2204-arm
            os: linux
            arch: arm64
            docker_image: ghcr.io/viamrobotics/antique2:arm64-cache
          - runner: macos-14
            os: darwin
            arch: arm64
          - runner: ubuntu-latest
            os: windows
            arch: amd64
            docker_image: ghcr.io/viamrobotics/antique2:amd64-cache

    runs-on: ${{ matrix.runner }}

    steps:
    - uses: actions/checkout@v4

    - name: Build module
      uses: ./.github/actions/build-module
      with:
        target_os: ${{ matrix.os }}
        target_arch: ${{ matrix.arch }}
        docker_image: ${{ matrix.docker_image }}

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: viamrtsp-${{ matrix.os }}-${{ matrix.arch }}
        path: module.tar.gz
        retention-days: 1
        if-no-files-found: error

  test:
    name: Test ${{ matrix.config.name }}/${{ matrix.config.transport }} (${{ matrix.platform.os }}/${{ matrix.platform.arch }})
    needs: build
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: ubuntu-latest
            os: linux
            arch: amd64
          - runner: buildjet-8vcpu-ubuntu-2204-arm
            os: linux
            arch: arm64
          - runner: macos-14
            os: darwin
            arch: arm64
          - runner: windows-latest
            os: windows
            arch: amd64
        config:
          - name: "h264"
            codec: "libx264"
            pix_fmt: "yuv420p"
            transport: "tcp"
          - name: "h265"
            codec: "libx265"
            pix_fmt: "yuv420p"
            transport: "tcp"
          - name: "mjpeg"
            codec: "mjpeg"
            extra_ffmpeg_args: "-huffman 0"
            pix_fmt: "yuvj420p"
            transport: "tcp"
          - name: "mpeg4"
            codec: "mpeg4"
            pix_fmt: "yuv420p"
            transport: "tcp"
          - name: "h264"
            codec: "libx264"
            pix_fmt: "yuv420p"
            transport: "udp"
          - name: "h265"
            codec: "libx265"
            pix_fmt: "yuv420p"
            transport: "udp"
          - name: "mjpeg"
            codec: "mjpeg"
            extra_ffmpeg_args: "-huffman 0"
            pix_fmt: "yuvj420p"
            transport: "udp"
          - name: "mpeg4"
            codec: "mpeg4"
            pix_fmt: "yuv420p"
            transport: "udp"

    runs-on: ${{ matrix.platform.runner }}

    defaults:
      run:
        shell: bash

    steps:
    - uses: actions/checkout@v4

    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: viamrtsp-${{ matrix.platform.os }}-${{ matrix.platform.arch }}

    - name: Extract module
      if: runner.os != 'Windows'
      run: tar -xzf module.tar.gz

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Install dependencies
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          choco install ffmpeg -y
        else
          make install-deps
        fi

    - name: Download mediamtx
      run: ./etc/download-mediamtx.sh

    - name: Run mediamtx
      run: ./etc/run-mediamtx.sh

    - name: Run fake RTSP camera
      run: ./etc/run-fake-camera.sh "${{ matrix.config.codec }}" "${{ matrix.config.pix_fmt }}" "${{ matrix.config.transport }}" "${{ matrix.config.extra_ffmpeg_args }}"

    - name: Install viam-server
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          curl -o viam-server.exe https://storage.googleapis.com/packages.viam.com/apps/viam-server/viam-server-v0.109.0-windows-x86_64
        else
          make viam-server
        fi

    - name: Generate viam-server config
      run: ./etc/generate-config.sh "${{ matrix.config.name }}"

    - name: Debug - Show config
      run: cat "integration-test-config-${{ matrix.config.name }}.json"

    - name: Run viam-server
      run: ./etc/run-viam-server.sh "./integration-test-config-${{ matrix.config.name }}.json" 15

    - name: Build and run test binary
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          go build -o testBinary.exe ./test/client.go
          ./testBinary.exe
        else
          go build -o testBinary ./test/client.go
          chmod +x ./testBinary
          ./testBinary
        fi
